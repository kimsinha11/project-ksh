<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper
	namespace="com.KoreaIT.ksh.demo.repository.ReviewRepository">



	<select id="getReviews" resultType="Review">
		SELECT review.*,
		IFNULL(SUM(reactionPoint.point),0) AS extra__sumReactionPoint,
		IFNULL(SUM(IF(reactionPoint.point &gt; 0,reactionPoint.point,0)),0) AS extra__goodReactionPoint,
		IFNULL(SUM(IF(reactionPoint.point &lt; 0,reactionPoint.point,0)),0) AS extra__badReactionPoint,
		member.name AS 'name'
		FROM review
		INNER JOIN
		`member`
		ON review.memberId =
		member.id
		LEFT JOIN reactionPoint
		ON review.id = reactionPoint.relId AND reactionPoint.relTypeCode = 'review'
		WHERE 1
		<if test="boardId != 0">
			AND review.boardId = #{boardId}
		</if>
		<if test="searchKeyword != null and searchKeyword != ''">
			<choose>
				<when test="searchId != null and searchId.intValue() == 1">
					AND title LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
				<when test="searchId != null and searchId.intValue() == 2">
					AND body LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
				<otherwise>
					AND (title LIKE CONCAT('%', #{searchKeyword}, '%') OR
					body LIKE
					CONCAT('%', #{searchKeyword}, '%'))
				</otherwise>
			</choose>
		</if>
		GROUP BY review.id
		ORDER BY review.id DESC
		<if test="i >= 0">
			LIMIT #{i}, #{itemsPerPage}
		</if>
	</select>

	<select id="getReview" resultType="Review">
		SELECT review.*,
		IFNULL(SUM(reactionPoint.point),0) AS extra__sumReactionPoint,
		IFNULL(SUM(IF(reactionPoint.point &gt; 0,reactionPoint.point,0)),0) AS extra__goodReactionPoint,
		IFNULL(SUM(IF(reactionPoint.point &lt; 0,reactionPoint.point,0)),0) AS extra__badReactionPoint, member.name AS 'name'
		FROM review
		INNER JOIN `member`
		ON review.memberId = member.id
		LEFT JOIN reactionPoint
		ON review.id = reactionPoint.relId AND reactionPoint.relTypeCode = 'review'
		WHERE review.id
		=
		#{id}
		
	</select>

	<delete id="deleteReview">
		DELETE FROM
		review
		WHERE id = #{id}
	</delete>
	
</mapper>